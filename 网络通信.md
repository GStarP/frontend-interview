# 网络通信

### TCP 和 UDP

- 都是传输层协议
- TCP
  - 提供可靠的字节流服务
    - 字节流：将大块数据分割成以报文段为单位的数据包进行管理
    - 可靠：能够确认数据最终是否到达对方
  - 三次握手
    - 起初，客户端为 CLOSED 状态；服务器为 LISTEN 状态
    - 第一次：建立连接时，客户端发送 SYN(=j) 包到服务器，等待服务器确认；客户端进入 SYN_SEND 状态
    - 第二次：服务器收到 SYN(=j)，确认客户端的 SYN(=j)，返回 ACK(=j+1)，同时自己也发送一个 SYN(=k) 包；服务器进入 SYN_RECV 状态
    - 第三次：客户端收到 SYN(=k) 和 ACK(=j+1)，向服务器发送确认包 ACK(=k+1)；客户端进入 ESTABLISHED 状态
    - 服务端接收到 ACK(=k+1)，服务端进入 ESTABLISHED 状态
  - 四次挥手
    - 第一次：客户端发送一个 FIN(=M) ，客户端关闭到服务端的数据传送；客户端进入 FIN_WAIT_1 状态
    - 第二次：服务端收到 FIN(=M)，返回 ACK(=M+1)；服务端进入 CLOSE_WAIT 状态
    - 第三次：服务端完成全部的数据传输，向客户端发送 FIN(=N)；服务端进入 LAST_ACK 状态
    - 第四次：客户端收到 FIN(=N)，返回 ACK(=N+1)；客户端进入 TIME_WAIT 状态，该状态持续 2MSL，若这段时间内没有收到服务端重发请求，就进入 CLOSED 状态
    - 服务端收到 ACK(=N+1)，进入 CLOSED 状态
  - 特点
    - 面向连接：传输数据前必须经过三次握手建立连接
    - 仅支持一对一通信
    - 以字节流方式进行传输
    - 可靠传输：给每个包一个序号，序号也保证了包的按序接收；接收端对已成功收到的包发回一个相应的确认（ACK）；如果发送端在合理的往返时延（RTT）内未收到确认，那么对应的数据将会被重传
    - 拥塞控制：当网络出现拥塞的时候，TCP 能够减小向网络注入数据的速率和数量，缓解拥塞
    - 首部最小 20 字节，最大 60 字节
    - 适用于要求可靠传输的应用，如文件传输
- UDP
  - 无连接：不需要建立连接，想发就发
  - 能支持一对多和多对多的传输
  - 面向报文：对于应用层传下来的报文，在添加首部后就向下交付到 IP 层，不做合并或拆分，保留报文边界
  - 不可靠性：不备份，也不关心对方是否收到数据
  - 无拥塞控制，一直以恒定速率发送数据，因此网络条件不好的情况下可能丢包
  - 首部开销较小，传输报文效率高，共 8 字节：2 字节源端口号 + 2 字节目标端口号 +2 字节整个报文长度 + 2 字节校验和
  - 适用于实时应用（视频会议，直播等）