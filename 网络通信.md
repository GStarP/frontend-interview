# 网络通信

## TCP 和 UDP

- 都是传输层协议
- TCP
  - 提供可靠的字节流服务
    - 字节流：将大块数据分割成以报文段为单位的数据包进行管理
    - 可靠：能够确认数据最终是否到达对方
  - 三次握手
    - 起初，客户端为 CLOSED 状态；服务器为 LISTEN 状态
    - 第一次：建立连接时，客户端发送 SYN(=j) 包到服务器，等待服务器确认；客户端进入 SYN_SEND 状态
    - 第二次：服务器收到 SYN(=j)，确认客户端的 SYN(=j)，返回 ACK(=j+1)，同时自己也发送一个 SYN(=k) 包；服务器进入 SYN_RECV 状态
    - 第三次：客户端收到 SYN(=k) 和 ACK(=j+1)，向服务器发送确认包 ACK(=k+1)；客户端进入 ESTABLISHED 状态
    - 服务端接收到 ACK(=k+1)，服务端进入 ESTABLISHED 状态
  - 四次挥手
    - 第一次：客户端发送一个 FIN(=M) ，客户端关闭到服务端的数据传送；客户端进入 FIN_WAIT_1 状态
    - 第二次：服务端收到 FIN(=M)，返回 ACK(=M+1)；服务端进入 CLOSE_WAIT 状态
    - 第三次：服务端完成全部的数据传输，向客户端发送 FIN(=N)；服务端进入 LAST_ACK 状态
    - 第四次：客户端收到 FIN(=N)，返回 ACK(=N+1)；客户端进入 TIME_WAIT 状态，该状态持续 2MSL，若这段时间内没有收到服务端重发请求，就进入 CLOSED 状态
    - 服务端收到 ACK(=N+1)，进入 CLOSED 状态
  - 特点
    - 面向连接：传输数据前必须经过三次握手建立连接
    - 仅支持一对一通信
    - 以字节流方式进行传输
    - 可靠传输：给每个包一个序号，序号也保证了包的按序接收；接收端对已成功收到的包发回一个相应的确认（ACK）；如果发送端在合理的往返时延（RTT）内未收到确认，那么对应的数据将会被重传
    - 拥塞控制：当网络出现拥塞的时候，TCP 能够减小向网络注入数据的速率和数量，缓解拥塞
    - 首部最小 20 字节，最大 60 字节
    - 适用于要求可靠传输的应用，如文件传输
- UDP
  - 无连接：不需要建立连接，想发就发
  - 能支持一对多和多对多的传输
  - 面向报文：对于应用层传下来的报文，在添加首部后就向下交付到 IP 层，不做合并或拆分，保留报文边界
  - 不可靠性：不备份，也不关心对方是否收到数据
  - 无拥塞控制，一直以恒定速率发送数据，因此网络条件不好的情况下可能丢包
  - 首部开销较小，传输报文效率高，共 8 字节：2 字节源端口号 + 2 字节目标端口号 +2 字节整个报文长度 + 2 字节校验和
  - 适用于实时应用（视频会议，直播等）

## HTTP 状态码

- 1：信息，服务器收到请求，需要请求者继续操作
  - 100：客户端应继续其请求
  - 101：服务端根据客户端的要求切换协议（只能切换到更高）
- 2：请求被成功接收并处理
  - 200（OK）：请求成功
  - 202（Accepted）：已接受请求，但未完成处理
- 3：重定向
  - 301（Moved Permanently）：永久移动，请求资源已移动到新的 URI，自动重定向到新 URI，今后任何请求都应该以新的 URI 代替
  - 302（Found）：暂时移动，资源只是临时移动，客户端此后应继续使用原本的 URL
  - 304（Not Modified）：未修改，所请求的资源未修改（详见浏览器缓存相关）
  - 305（Use Proxy）：使用代理，所请求的资源必须通过代理访问
- 4：客户端错误
  - 400（Bad Request）：请求语法错误，服务器无法理解
    - 请求的字段名称与后端定义的不一致
  - 401（Unauthorized）：要求用户进行身份认证
  - 403（Forbidden）：服务器理解客户端请求，但拒绝执行
    - 没有访问资源的权限；反爬机制
  - 404（Not Found）：服务器无法根据请求找到相应的资源
  - 429（Too Many Requests）：限制客户端请求服务的数量，会返回延时 Refer-After
- 5：服务器错误
  - 500（Internal Error）：服务器内部错误
  - 501（Not Implemented）：服务器不支持请求的功能
  - 502（Bad Gateway）：作为网关或代理工作的服务器尝试执行请求时，从远程服务器收到了一个无效响应
  - 503（Service Unavailable）：由于超载或系统维护，服务器暂时无法处理客户端请求；会返回延时 Refer-After
  - 504（Gateway Time-out）：充当网关或代理的服务器，未及时从远端服务器获取请求
    - 负载很大（抢票）；延迟过高
  - 505（HTTP Version not supported）：服务器不支持当前版本的 HTTP 请求

## Session 机制

- 当服务端需要为请求创建一个 session 时，首先检查请求中是否携带 session id
  - 若包含且能检索到，使用对应的 session
  - 否则，创建一个新 session 并生成一个 session id，返回给客户端
- 保存 session id 一般使用 cookie
- 但 cookie 有时候会被认为禁止，这个时候可以使用一种叫做 **URL 重写** 的古老技术
  - 将请求的基路径修改为 http://xxx.com;jsessionid=Bkg2X6Hna8
- 或在表单里偷偷藏一个 <input type="hidden" name="jsessionid" value="Bkg2X6Hna8">
- 误解：关闭浏览器 session 就会消失
  - 除非客户端通过服务端关闭 session（登出），否则服务端不会轻易删除 session
    - 因此，服务端必须为 session 设置过期时间
  - 造成误解的原因是因为一般都使用会话 cookie 来保存 sessionid，它在浏览器关闭后就消失了

